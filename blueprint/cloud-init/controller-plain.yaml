#cloud-config
  hostname: ${hostname}
  timezone: Asia/Seoul
  users:
    - default
    - name: celestrial
      groups:
        - sudo
      shell: /bin/bash
      ssh_authorized_keys:
        - ${ssh_pubkey}
      sudo: ALL=(ALL) NOPASSWD:ALL
  package_update: true
  packages:
    - qemu-guest-agent
    - apt-transport-https 
    - ca-certificates 
    - containerd
    - curl
    - gnupg
  write_files:
    - path: /etc/kubernetes/kubeadm.yaml
      content: |
        ${indent(8, file("cloud-init/kubernetes/kubeadm.yaml"))}
    - path: /etc/kubernetes/calico.yaml
      content: |
        ${indent(8, file("cloud-init/kubernetes/calico.yaml"))}
  runcmd:
    - systemctl enable --now qemu-guest-agent
    - mkdir -p /etc/containerd
    - containerd config default > /etc/containerd/config.toml
    - sed -i s#sandbox_image\ =\ ".*"#sandbox_image\ =\ "registry.k8s.io/pause:3.10.1"# /etc/containerd/config.toml
    - systemctl enable --now containerd
    - sysctl -w net.ipv4.ip_forward=1
    - echo "deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.34/deb/ /" | sudo tee /etc/apt/sources.list.d/kubernetes.list
    - curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.28/deb/Release.key | sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
    - apt-get update
    - apt-get install -y kubelet kubeadm kubectl
    - apt-mark hold kubelet kubeadm kubectl
    - echo "done" > /tmp/cloud-config.done